<!DOCTYPE html>
<html>
<head>
	<title>ESPanel</title>
	<meta name="viewport" content="width=device-width, user-scalable=no,initial-scale=1, maximum-scale=1">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> 
	<meta name="apple-mobile-web-app-capable" content="yes"> 
	<meta name="apple-mobile-web-app-title" content="mobiAPP"> 
	<meta name="mobile-web-app-capable" content="yes"> 
	<link rel="icon" type="image/png" size="128x128" href="img/esp.jpg"> 
	<link rel="shortcut icon" type="image/png" size="128x128" href="img/esp.jpg"> 
	<link rel="apple-touch-icon" href="img/esp.jpg"> 	
	
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

  <script src="/socket.io/socket.io.js"></script>
	<style>
		button {margin:0.33em;}
		pre {
			margin-bottom: 0;
			font-size: 0.8rem;
			line-height: 1rem;
		}
		textarea#message {min-height:20em;}
	</style>

<script>
   var socket = io();
   $(function () {    
        $("#send").click(function(){
            sendMessage({name:"test",message: $("#espfile").val(), value: $("#message").val()});
			//sendMessage({"name":"serial", "message": "open", "value":option.serial});
        })
        //getMessages()
    })

    socket.on('message', addMessages);
    socket.on('info', addInfoMessages);
    socket.on('filelist', addfilelistMessages);
    socket.on('filedownload', filedownloadMessages);
	
	

    function addInfoMessages(m){
		console.log(m);
		if (m.echo){
			$("#info").html('<pre>' +m.echo+'\n</pre>');
				if (m.response){
					$("#info").append('<pre>' +m.response+'\n</pre>');
				}
		} else {
			$("#info").append('<pre>' +m+'\n</pre>');
		}
    }
	
	
    function addMessages(message){
		console.log(message)
        if(message.name) $("#messages").html('<pre>' +message.name+' :: '+message.message+'\n</pre>');
    }
    function addfilelistMessages(m){
		console.log('addfilelistMessages=',m)
		$("#terminal").append('<pre>remaining=' +m.metadata.remaining+'kB\n</pre>')
		$("#terminal").append('<pre>total=' +m.metadata.total+'kB\n</pre>')
		$("#terminal").append('<pre>used=' +m.metadata.used+'kB\n</pre>')
		
					$('#terminal').append(  '<table />' );
					let tabelka = $('#terminal table');
					tabelka.addClass("table table-striped table-sm")
					//m.files.sort();
					$.each(m.files,function(i,x){
						let klawisz='...';
						let arr=x.name.split('.');
						let ext = arr.pop();
						let onKlik = 'runLua("'+x.name+'")';
						if (ext==='lua') klawisz='<button onClick='+onKlik+'>Exec</button>';
						//console.log(klawisz)
						//klawisz="klaw";
						tabelka.append( '<tr><td>'+ext+'</td><td>'+x.name+'</td><td>'+x.size+'</td><td>'+klawisz+'</td></tr>' );
					});
					//$('#terminal').append(  '</table>' );
				console.log($($('#terminal table')))
    }
    function filedownloadMessages(mbuff){
		console.log('-filedownloadMessages---')
		console.log(mbuff)
		console.log()
		$('#message').text(mbuff.toString())
    }
	
	
	

    function getMessages(){
      $.get('http://localhost:3009/messages', function(data) {
		console.log(data)
        if (data && data !='OK') data.forEach(addMessages);
      })
    }

    function sendMessage(message){
      $.post('http://localhost:3009/messages', message)
    }
</script>
	
<script>

var option={}
	option.serial="COM3";



function executeLua(code){
	code = code || $("#message").val();
	console.log('executeLua=',code);
	sendMessage({"name":"lua", "message":"execute", "value":code});
}
function runLua(file){
	file = file || $("#espfile").val();
	console.log('runLua=',file);
	sendMessage({"name":"lua", "message":"run", "value":file});
}
function serialAction(mess){
	console.log('serialAction=',mess);
	sendMessage({"name":"serial", "message":mess});
}
function checkSerial(){
	console.log('checkSerial');
	sendMessage({"name":"serial", "message": "check"});
}
function openSerial(){
	console.log('openSerial');
	sendMessage({"name":"serial", "message": "open", "value":option.serial});
}
function resetESP(){
	console.log('resetESP');
	sendMessage({"name":"esp", "message": "reset", "value":option.serial});
}
function fsinfoESP(){
	console.log('fsinfo');
	sendMessage({"name":"esp", "message": "fsinfo", "value":option.serial});
}
function uploadESP(){
	let file = $("#luaname").text()
	console.log('uploadESP',file);
	sendMessage({"name":"esp", "message": "upload", "value":file});
}
function downloadESP(){
	let file = $("#luaname").text()
	console.log('downloadESP',file);
	sendMessage({"name":"esp", "message": "download", "value":file});
}



</script>
	
</head>
<body>
<div class="container">

    <div class="row">
		<div class="col-sm">
			<h5>ESPanel</h5>
			<button class="btn btn-primary" 		onClick="uploadESP()">UPLOAD <span id="luaname">aaa.lua</span></button>
			<button class="btn btn-secondary" 		onClick="downloadESP()">Download <span id="luaname">aaa.lua</span></button>
			
			<div>
				<button class="btn btn-info" 	onClick="checkSerial()">Check Serial</button>
				<button class="btn btn-success" 	onClick="openSerial()">Open Serial</button>
				<button class="btn btn-danger" 	onClick="fsinfoESP()">LUA files</button>
				<button class="btn btn-warning" 	onClick="resetESP()">Reset</button>
				<hr />
				<button class="btn btn-light" 	onClick="serialAction('connect')">connect</button>
				<button class="btn btn-light" 	onClick="serialAction('isConnected')">isConnected</button>
				<button class="btn btn-light" 	onClick="serialAction('disconnect')">disconnect</button>
				<button class="btn btn-light" 	onClick="serialAction('checkConnection')">checkConnection</button>
				<button class="btn btn-light" 	onClick="runLua()">Run</button>
				<button class="btn btn-light" 	onClick="executeLua('print(node.heap())')">Heap</button>
				
				
    	
			</div>
			<div class="">
				<span class="col-sm" id="terminal"></span>
				<span class="col-sm" id="messages"></span>
				<span class="col-sm" id="info"></span>
			</div>
			
		</div>
		<div class="col-sm">
			<div>
			<span style="font:bold 1.2rem Verdana">Editon </span>
			<button class="btn btn-dark" 	onClick="runLua()">Run</button>
			</div>
			
			<input id = "espfile" class="form-control" value="aaa.lua"><br />
			<textarea id="message" class="form-control" onkeydown="if(event.keyCode===9){var v=this.value,s=this.selectionStart,e=this.selectionEnd;this.value=v.substring(0, s)+'\t'+v.substring(e);this.selectionStart=this.selectionEnd=s+1;return false;}">print("aaa")</textarea><br />
			<button id="send" class="btn btn-success">Save & Send & Run ???</button>
		</div>
	</div>
	
</div>

</body>
</html>
<!--
<button type="button" class="btn">Basic</button>
<button type="button" class="btn btn-primary">Primary</button>
<button type="button" class="btn btn-secondary">Secondary</button>
<button type="button" class="btn btn-success">Success</button>
<button type="button" class="btn btn-info">Info</button>
<button type="button" class="btn btn-warning">Warning</button>
<button type="button" class="btn btn-danger">Danger</button>
<button type="button" class="btn btn-dark">Dark</button>
<button type="button" class="btn btn-light">Light</button>
<button type="button" class="btn btn-link">Link</button>
-->